<!DOCTYPE html>
<html>
<head>
    <title>Debug Notifications</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px; margin: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>üîß Debug Notification System</h1>
    
    <div class="section">
        <h3>1. Current Configuration Check</h3>
        <button onclick="checkConfig()">Check Config</button>
        <div id="configResult"></div>
    </div>
    
    <div class="section">
        <h3>2. Test FCM Token Registration</h3>
        <button onclick="testFCMRegistration()">Test FCM</button>
        <div id="fcmResult"></div>
    </div>
    
    <div class="section">
        <h3>3. Test Cloud Function Trigger</h3>
        <button onclick="testCloudFunction()">Create Test Call</button>
        <div id="cloudFunctionResult"></div>
    </div>
    
    <div class="section">
        <h3>4. Check Existing FCM Tokens</h3>
        <input type="text" id="userIdInput" placeholder="User ID" style="padding: 5px; width: 300px;">
        <button onclick="checkTokens()">Check Tokens</button>
        <div id="tokensResult"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>
    
    <script>
        // Initialize Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyAg6TXwgejbPAyuEPEBqW9eHaZyLV4Wq98",
            authDomain: "easosunov-webrtc.firebaseapp.com",
            projectId: "easosunov-webrtc",
            storageBucket: "easosunov-webrtc.firebasestorage.app",
            messagingSenderId: "100169991412",
            appId: "1:100169991412:web:27ef6820f9a59add6b4aa1"
        });
        
        const db = firebase.firestore();
        const messaging = firebase.messaging();
        const VAPID_KEY = "BCR4B8uf0WzUuzHKlBCJO22NNnnupe88j8wkjrTwwQALDpWUeJ3umtIkNJTrLb0I_LeIeu2HyBNbogHc6Y7jNzM";
        
        function log(selector, message, className = 'info') {
            const element = document.getElementById(selector);
            element.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }
        
        async function checkConfig() {
            log('configResult', 'Checking Firebase configuration...');
            
            try {
                // Check Firebase app
                log('configResult', `‚úÖ Firebase App: ${firebase.app().name}`, 'success');
                log('configResult', `‚úÖ Project: ${firebase.app().options.projectId}`, 'success');
                
                // Check VAPID key
                if (VAPID_KEY && !VAPID_KEY.includes('PASTE')) {
                    log('configResult', `‚úÖ VAPID Key configured`, 'success');
                } else {
                    log('configResult', `‚ùå VAPID Key missing or placeholder`, 'error');
                }
                
                // Test Firestore connection
                const testDoc = await db.collection('_test').doc('connection').get();
                log('configResult', '‚úÖ Firestore connection successful', 'success');
                
            } catch (error) {
                log('configResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function testFCMRegistration() {
            log('fcmResult', 'Testing FCM registration...');
            
            try {
                // Request notification permission
                const permission = await Notification.requestPermission();
                log('fcmResult', `Notification permission: ${permission}`, permission === 'granted' ? 'success' : 'error');
                
                if (permission !== 'granted') {
                    return;
                }
                
                // Register service worker
                const registration = await navigator.serviceWorker.register('/easosunov/firebase-messaging-sw.js', {
                    scope: '/easosunov/'
                });
                
                log('fcmResult', `‚úÖ Service Worker registered: ${registration.scope}`, 'success');
                
                // Get FCM token
                const token = await messaging.getToken({
                    vapidKey: VAPID_KEY,
                    serviceWorkerRegistration: registration
                });
                
                if (token) {
                    log('fcmResult', `‚úÖ FCM Token obtained (first 30 chars): ${token.substring(0, 30)}...`, 'success');
                    log('fcmResult', `Token length: ${token.length} characters`, 'info');
                    
                    // Save to a test location
                    const tokenId = token.substring(0, 32);
                    await db.collection('_debug').doc('fcm-test').set({
                        token: token,
                        tokenPreview: token.substring(0, 30) + '...',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    }, { merge: true });
                    
                    log('fcmResult', '‚úÖ Token saved to Firestore at /_debug/fcm-test', 'success');
                    
                } else {
                    log('fcmResult', '‚ùå No FCM token returned', 'error');
                }
                
            } catch (error) {
                log('fcmResult', `‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testCloudFunction() {
            log('cloudFunctionResult', 'Testing Cloud Function trigger...');
            
            try {
                // Create a test call document
                const testCallId = 'test-' + Date.now();
                const testCall = {
                    fromUid: 'debug-user',
                    toUid: prompt('Enter recipient User ID to test:') || 'test-recipient',
                    fromName: 'Debug Tester',
                    status: 'ringing',
                    roomId: 'test-room-' + testCallId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    note: 'Test notification from debug tool'
                };
                
                log('cloudFunctionResult', `Creating test call with ID: ${testCallId}`, 'info');
                log('cloudFunctionResult', `To UID: ${testCall.toUid}`, 'info');
                
                // Save to Firestore
                await db.collection('calls').doc(testCallId).set(testCall);
                
                log('cloudFunctionResult', '‚úÖ Test call document created in Firestore', 'success');
                log('cloudFunctionResult', `Document path: calls/${testCallId}`, 'info');
                
                // Check if Cloud Function will trigger
                log('cloudFunctionResult', 'Cloud Function should trigger automatically...', 'info');
                log('cloudFunctionResult', 'Check Firebase Console ‚Üí Functions ‚Üí Logs', 'info');
                
            } catch (error) {
                log('cloudFunctionResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function checkTokens() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }
            
            log('tokensResult', `Checking FCM tokens for user: ${userId}...`);
            
            try {
                const tokensSnapshot = await db.collection('users').doc(userId).collection('fcmTokens').get();
                
                if (tokensSnapshot.empty) {
                    log('tokensResult', `‚ùå No FCM tokens found for user ${userId}`, 'error');
                    return;
                }
                
                log('tokensResult', `‚úÖ Found ${tokensSnapshot.size} FCM token(s):`, 'success');
                
                tokensSnapshot.forEach(doc => {
                    const data = doc.data();
                    log('tokensResult', `Token ID: ${doc.id}`, 'info');
                    log('tokensResult', `  Enabled: ${data.enabled || false}`, 'info');
                    log('tokensResult', `  Platform: ${data.platform || 'unknown'}`, 'info');
                    log('tokensResult', `  Created: ${data.createdAt ? new Date(data.createdAt).toLocaleString() : 'unknown'}`, 'info');
                    log('tokensResult', `  Token preview: ${data.token ? data.token.substring(0, 30) + '...' : 'missing'}`, 'info');
                });
                
            } catch (error) {
                log('tokensResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
