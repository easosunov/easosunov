<!DOCTYPE html>
<html>
<head>
    <title>Windows Background Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { margin: 5px; padding: 10px; }
        #status { margin-top: 20px; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h2>Windows Background Notification Test</h2>
    
    <button onclick="testServiceWorker()">1. Test Service Worker</button>
    <button onclick="testNotification()">2. Test Basic Notification</button>
    <button onclick="testFCM()">3. Test FCM Registration</button>
    <button onclick="testBackgroundApp()">4. Test Background App</button>
    
    <div id="status"></div>
    
    <script>
        function log(msg) {
            console.log(msg);
            document.getElementById('status').innerHTML += msg + '<br>';
        }
        
        async function testServiceWorker() {
            log('=== Testing Service Worker ===');
            
            if (!('serviceWorker' in navigator)) {
                log('❌ Service Worker not supported');
                return;
            }
            
            try {
                // Try to register service worker
                const registration = await navigator.serviceWorker.register('/easosunov/firebase-messaging-sw.js', {
                    scope: '/easosunov/'
                });
                
                log(`✅ Service Worker registered: ${registration.scope}`);
                log(`Active: ${registration.active ? 'Yes' : 'No'}`);
                log(`Waiting: ${registration.waiting ? 'Yes' : 'No'}`);
                
                // Wait for ready
                await navigator.serviceWorker.ready;
                log('✅ Service Worker ready');
                
            } catch (error) {
                log(`❌ Service Worker error: ${error.message}`);
            }
        }
        
        async function testNotification() {
            log('=== Testing Basic Notifications ===');
            
            const permission = await Notification.requestPermission();
            log(`Notification permission: ${permission}`);
            
            if (permission === 'granted') {
                // Test basic notification
                const notification = new Notification('Test Notification', {
                    body: 'This is a basic Windows notification',
                    icon: '/easosunov/icons/RTC192.png'
                });
                log('✅ Basic notification shown');
            }
        }
        
        async function testFCM() {
            log('=== Testing FCM ===');
            
            // First check if we have the necessary Firebase setup
            if (typeof firebase === 'undefined') {
                log('❌ Firebase not loaded');
                return;
            }
            
            // Check if messaging is available
            if (!firebase.messaging) {
                log('❌ Firebase Messaging not available');
                return;
            }
            
            log('✅ Firebase Messaging available');
            
            // Try to get current token
            try {
                const messaging = firebase.messaging();
                const token = await messaging.getToken({
                    vapidKey: 'BCR4B8uf0WzUuzHKlBCJO22NNnnupe88j8wkjrTwwQALDpWUeJ3umtIkNJTrLb0I_LeIeu2HyBNbogHc6Y7jNzM'
                });
                
                if (token) {
                    log(`✅ FCM Token: ${token.substring(0, 30)}...`);
                } else {
                    log('❌ No FCM token');
                }
            } catch (error) {
                log(`❌ FCM Error: ${error.message}`);
            }
        }
        
        async function testBackgroundApp() {
            log('=== Testing Background App ===');
            
            try {
                // Test if background app is running on localhost:3000
                const response = await fetch('http://localhost:3000/status', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ Background app running: ${JSON.stringify(data)}`);
                } else {
                    log('❌ Background app not responding');
                }
            } catch (error) {
                log(`❌ Background app error: ${error.message}`);
                log('Make sure webrtc-notifier.exe is running in system tray');
            }
        }
    </script>
</body>
</html>
