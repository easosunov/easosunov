<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>2-Person WebRTC (Manual Signaling, No Firebase)</title>
<style>
  body{font-family:system-ui;margin:16px}
  h1{font-size:20px;margin:0 0 10px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;flex:1 1 360px}
  .videos{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 720px){ .videos{grid-template-columns:1fr} }
  video{width:100%;background:#000;border-radius:12px;aspect-ratio:16/9}
  button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  textarea{width:100%;min-height:120px;padding:10px;border-radius:10px;border:1px solid #ccc;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
  .status{font-size:13px;margin-top:8px}
  .small{font-size:12px;color:#555;margin-top:6px}
  .badge{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#333;background:#fafafa}
  #errorBox{display:none;margin:12px 0;padding:10px;border:1px solid #f3b5b5;background:#fff5f5;color:#7a1b1b;border-radius:12px;white-space:pre-wrap}
  #diagBox{display:none;margin-top:8px;max-height:260px;overflow:auto;background:#111;color:#0f0;padding:8px;border-radius:8px;font-size:12px;white-space:pre-wrap}
</style>
</head>
<body>

<script>
  const BUILD = "2025-12-26T00:20Z-MANUAL-SIGNALING-NO-FIRESTORE";
</script>

<h1>2-Person WebRTC (Manual Signaling) <span id="buildBadge" class="badge"></span></h1>
<div id="errorBox"></div>

<div class="videos">
  <div class="card">
    <b>You</b>
    <video id="localVideo" autoplay muted playsinline></video>
    <div class="small">Muted so you don’t hear yourself.</div>
  </div>
  <div class="card">
    <b>Other</b>
    <video id="remoteVideo" autoplay playsinline></video>
    <div class="small">If audio doesn’t play, click the remote video once.</div>
  </div>
</div>

<div class="row" style="margin-top:12px">
  <div class="card">
    <b>Step 1 — Media</b><br/><br/>
    <button id="startBtn">Start camera/mic</button>
    <button id="stopBtn" disabled>Stop</button>
    <div class="status" id="mediaStatus">Not started.</div>
  </div>

  <div class="card">
    <b>Step 2 — Choose a role</b><br/><br/>
    <button id="hostBtn" disabled>I'm Person A (Host)</button>
    <button id="guestBtn" disabled>I'm Person B (Guest)</button>
    <div class="status" id="roleStatus">No role selected.</div>
    <div class="small">Host creates an Offer. Guest pastes it and creates an Answer.</div>
  </div>
</div>

<div class="row" style="margin-top:12px">
  <div class="card">
    <b>Offer (from Host → send to Guest)</b>
    <div class="small">Host: click “Create Offer”, then copy and send this text to Guest.</div>
    <button id="createOfferBtn" disabled>Create Offer</button>
    <button id="copyOfferBtn" disabled>Copy Offer</button>
    <textarea id="offerOut" placeholder="Offer will appear here..."></textarea>
    <div class="status" id="offerStatus">—</div>
  </div>

  <div class="card">
    <b>Answer (from Guest → send to Host)</b>
    <div class="small">Guest: paste Offer below, click “Create Answer”, then copy Answer and send back to Host.</div>
    <textarea id="offerIn" placeholder="Guest: paste Host's Offer here..."></textarea>
    <button id="createAnswerBtn" disabled>Create Answer</button>
    <button id="copyAnswerBtn" disabled>Copy Answer</button>
    <textarea id="answerOut" placeholder="Answer will appear here..."></textarea>
    <div class="status" id="answerStatus">—</div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <b>Host: Paste Answer to finish</b>
  <div class="small">Host: paste Guest’s Answer below and click “Apply Answer”.</div>
  <textarea id="answerIn" placeholder="Host: paste Guest's Answer here..."></textarea>
  <button id="applyAnswerBtn" disabled>Apply Answer</button>
  <div class="status" id="connStatus">Not connected.</div>
</div>

<div class="card" style="margin-top:12px">
  <button id="diagBtn">Diagnostics</button>
  <button id="copyDiagBtn" disabled>Copy log</button>
  <button id="clearDiagBtn" disabled>Clear log</button>
  <pre id="diagBox"></pre>
</div>

<script>
/* ========== UI ========== */
document.getElementById("buildBadge").textContent = "BUILD " + BUILD;

const errorBox = document.getElementById("errorBox");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const hostBtn = document.getElementById("hostBtn");
const guestBtn = document.getElementById("guestBtn");

const createOfferBtn = document.getElementById("createOfferBtn");
const copyOfferBtn = document.getElementById("copyOfferBtn");
const offerOut = document.getElementById("offerOut");
const offerStatus = document.getElementById("offerStatus");

const offerIn = document.getElementById("offerIn");
const createAnswerBtn = document.getElementById("createAnswerBtn");
const copyAnswerBtn = document.getElementById("copyAnswerBtn");
const answerOut = document.getElementById("answerOut");
const answerStatus = document.getElementById("answerStatus");

const answerIn = document.getElementById("answerIn");
const applyAnswerBtn = document.getElementById("applyAnswerBtn");
const mediaStatus = document.getElementById("mediaStatus");
const roleStatus = document.getElementById("roleStatus");
const connStatus = document.getElementById("connStatus");

const diagBtn = document.getElementById("diagBtn");
const diagBox = document.getElementById("diagBox");
const copyDiagBtn = document.getElementById("copyDiagBtn");
const clearDiagBtn = document.getElementById("clearDiagBtn");

/* ========== DIAGNOSTICS ========== */
let diagVisible = false;
const diagLog = [];
function logDiag(msg){
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  diagLog.push(line);
  console.log(line);
  if (diagVisible){
    diagBox.textContent = diagLog.join("\n");
    diagBox.scrollTop = diagBox.scrollHeight;
  }
  copyDiagBtn.disabled = diagLog.length === 0;
  clearDiagBtn.disabled = diagLog.length === 0;
}
logDiag("BOOT: " + BUILD);
logDiag("URL: " + location.href);

diagBtn.onclick = () => {
  diagVisible = !diagVisible;
  diagBox.style.display = diagVisible ? "block" : "none";
  diagBtn.textContent = diagVisible ? "Hide diagnostics" : "Diagnostics";
  if (diagVisible){
    diagBox.textContent = diagLog.join("\n");
    diagBox.scrollTop = diagBox.scrollHeight;
  }
};
clearDiagBtn.onclick = () => {
  diagLog.length = 0;
  if (diagVisible) diagBox.textContent = "";
  copyDiagBtn.disabled = true;
  clearDiagBtn.disabled = true;
  logDiag("Diagnostics cleared.");
};
copyDiagBtn.onclick = async () => {
  const text = diagLog.join("\n");
  if (!text) return;
  try{ await navigator.clipboard.writeText(text); logDiag("Copied diagnostics to clipboard."); }
  catch{ window.prompt("Copy diagnostics:", text); }
};

/* ========== ERRORS ========== */
function showError(e){
  errorBox.style.display = "block";
  errorBox.textContent = String(e?.stack || e?.message || e);
  logDiag("ERROR: " + String(e?.message || e));
}
function hideError(){
  errorBox.style.display = "none";
  errorBox.textContent = "";
}
window.addEventListener("error", (e)=> showError(e.error || e.message || e));
window.addEventListener("unhandledrejection", (e)=> showError(e.reason || e));

/* ========== WEBRTC CORE (NO FIRESTORE) ========== */
let localStream = null;
let pc = null;
let role = null; // "host" or "guest"

const rtcConfig = {
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
  // If you later add TURN, put it here.
};

function closePeer(){
  if (pc){
    pc.onicecandidate = null;
    pc.ontrack = null;
    pc.onconnectionstatechange = null;
    pc.oniceconnectionstatechange = null;
    try{ pc.close(); }catch{}
    pc = null;
  }
  remoteVideo.srcObject = null;
}

function ensurePeer(){
  closePeer();
  pc = new RTCPeerConnection(rtcConfig);
  logDiag("Created RTCPeerConnection");

  const rs = new MediaStream();
  remoteVideo.srcObject = rs;

  pc.ontrack = (e)=>{
    e.streams[0].getTracks().forEach(t=>rs.addTrack(t));
    remoteVideo.muted = false;
    remoteVideo.play().catch(()=>{});
    logDiag("ontrack: " + e.streams[0].getTracks().map(t=>t.kind).join(","));
  };

  pc.onconnectionstatechange = ()=>{
    logDiag("pc.connectionState=" + pc.connectionState);
    connStatus.textContent = "Connection: " + pc.connectionState;
  };
  pc.oniceconnectionstatechange = ()=>{
    logDiag("pc.iceConnectionState=" + pc.iceConnectionState);
  };

  if(!localStream) throw new Error("Local media not started.");
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
}

async function waitForIceComplete(timeoutMs=20000){
  if(!pc) throw new Error("No peer connection.");
  if (pc.iceGatheringState === "complete") return;
  logDiag("Waiting for ICE gathering to complete…");
  await new Promise((resolve, reject)=>{
    const t = setTimeout(()=>reject(new Error("ICE gathering timeout")), timeoutMs);
    pc.addEventListener("icegatheringstatechange", function onchg(){
      if (pc.iceGatheringState === "complete"){
        pc.removeEventListener("icegatheringstatechange", onchg);
        clearTimeout(t);
        resolve();
      }
    });
  });
}

function jsonPretty(obj){
  return JSON.stringify(obj, null, 2);
}

function parseJson(text){
  try{ return JSON.parse(text); }
  catch{ throw new Error("Invalid JSON. Make sure you copied the entire text."); }
}

async function copyText(text){
  if(!text) return false;
  if(navigator.clipboard && window.isSecureContext){
    try{ await navigator.clipboard.writeText(text); return true; }catch{}
  }
  window.prompt("Copy:", text);
  return false;
}

/* ========== BUTTON LOGIC ========== */
startBtn.onclick = async ()=>{
  try{
    hideError();
    mediaStatus.textContent = "Requesting camera/mic…";
    logDiag("Requesting getUserMedia…");
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localVideo.srcObject = localStream;
    await localVideo.play().catch(()=>{});
    mediaStatus.textContent = "Camera/mic started.";
    logDiag("Camera/mic started.");
    stopBtn.disabled = false;
    hostBtn.disabled = false;
    guestBtn.disabled = false;
    startBtn.disabled = true;
  }catch(e){
    showError(e);
  }
};

stopBtn.onclick = ()=>{
  try{
    logDiag("Stop clicked.");
    closePeer();
    if(localStream){
      localStream.getTracks().forEach(t=>t.stop());
      localStream = null;
    }
    localVideo.srcObject = null;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    hostBtn.disabled = true;
    guestBtn.disabled = true;
    createOfferBtn.disabled = true;
    createAnswerBtn.disabled = true;
    applyAnswerBtn.disabled = true;
    copyOfferBtn.disabled = true;
    copyAnswerBtn.disabled = true;
    offerOut.value = "";
    answerOut.value = "";
    offerIn.value = "";
    answerIn.value = "";
    role = null;
    roleStatus.textContent = "No role selected.";
    mediaStatus.textContent = "Not started.";
    connStatus.textContent = "Not connected.";
  }catch(e){
    showError(e);
  }
};

hostBtn.onclick = ()=>{
  role = "host";
  roleStatus.textContent = "Role: Host (Person A)";
  logDiag("Role selected: HOST");
  createOfferBtn.disabled = false;
  createAnswerBtn.disabled = true;
  applyAnswerBtn.disabled = false;
};

guestBtn.onclick = ()=>{
  role = "guest";
  roleStatus.textContent = "Role: Guest (Person B)";
  logDiag("Role selected: GUEST");
  createOfferBtn.disabled = true;
  createAnswerBtn.disabled = false;
  applyAnswerBtn.disabled = true;
};

createOfferBtn.onclick = async ()=>{
  try{
    hideError();
    if(role !== "host") throw new Error("You must choose Host role.");
    ensurePeer();
    offerStatus.textContent = "Creating offer…";
    logDiag("HOST creating offer…");
    const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:true });
    await pc.setLocalDescription(offer);
    await waitForIceComplete();
    const fullOffer = pc.localDescription;
    offerOut.value = jsonPretty(fullOffer);
    offerStatus.textContent = "Offer ready. Copy and send to Guest.";
    copyOfferBtn.disabled = !offerOut.value;
    logDiag("HOST offer ready (includes ICE).");
  }catch(e){
    showError(e);
    offerStatus.textContent = "Offer failed.";
  }
};

copyOfferBtn.onclick = async ()=>{
  const ok = await copyText(offerOut.value);
  logDiag(ok ? "Copied Offer to clipboard." : "Offer shown for manual copy.");
};

createAnswerBtn.onclick = async ()=>{
  try{
    hideError();
    if(role !== "guest") throw new Error("You must choose Guest role.");
    const offerObj = parseJson(offerIn.value.trim());
    ensurePeer();
    answerStatus.textContent = "Applying offer…";
    logDiag("GUEST setRemoteDescription(offer)...");
    await pc.setRemoteDescription(offerObj);

    logDiag("GUEST creating answer…");
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    await waitForIceComplete();
    const fullAnswer = pc.localDescription;

    answerOut.value = jsonPretty(fullAnswer);
    answerStatus.textContent = "Answer ready. Copy and send to Host.";
    copyAnswerBtn.disabled = !answerOut.value;
    logDiag("GUEST answer ready (includes ICE).");
  }catch(e){
    showError(e);
    answerStatus.textContent = "Answer failed.";
  }
};

copyAnswerBtn.onclick = async ()=>{
  const ok = await copyText(answerOut.value);
  logDiag(ok ? "Copied Answer to clipboard." : "Answer shown for manual copy.");
};

applyAnswerBtn.onclick = async ()=>{
  try{
    hideError();
    if(role !== "host") throw new Error("You must be Host to apply the answer.");
    if(!pc) throw new Error("Host: create offer first.");
    const ansObj = parseJson(answerIn.value.trim());
    logDiag("HOST setRemoteDescription(answer)...");
    await pc.setRemoteDescription(ansObj);
    connStatus.textContent = "Answer applied. Connecting…";
    logDiag("HOST answer applied.");
  }catch(e){
    showError(e);
  }
};

/* Helpful: tap remote video to kick audio autoplay */
remoteVideo.addEventListener("click", ()=> remoteVideo.play().catch(()=>{}));

</script>
</body>
</html>
