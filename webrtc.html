<script type="module">
/* ---------- ERROR HANDLING ---------- */
const errorBox=document.getElementById("errorBox");
function showError(e){
  errorBox.style.display="block";
  errorBox.textContent=String(e?.stack||e);
  console.error(e);
}
window.addEventListener("error",e=>showError(e.error||e.message||e));
window.addEventListener("unhandledrejection",e=>showError(e.reason||e));

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, doc, collection, addDoc, setDoc, getDoc, updateDoc,
  onSnapshot, getDocs, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

/* ---------- FIREBASE ---------- */
const app=initializeApp({
  apiKey:"AIzaSyAg6TXwgejbPAyuEPEBqW9eHaZyLV4Wq98",
  authDomain:"easosunov-webrtc.firebaseapp.com",
  projectId:"easosunov-webrtc",
  storageBucket:"easosunov-webrtc.firebasestorage.app",
  messagingSenderId:"100169991412",
  appId:"1:100169991412:web:27ef6820f9a59add6b4aa1"
});
const db=getFirestore(app);
const auth=getAuth(app);

/* ---------- AUTH GATE ---------- */
let isAuthed=false;

/* ---------- LOGIN UI ---------- */
const loginOverlay=document.getElementById("loginOverlay");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const loginStatus=document.getElementById("loginStatus");
const emailInput=document.getElementById("emailInput");
const passInput=document.getElementById("passInput");
const appRoot=document.getElementById("app");

loginBtn.onclick=async()=>{
  loginStatus.textContent="Signing in…";
  try{
    await signInWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value);
  }catch(e){
    loginStatus.textContent="Login failed. Check email/password.";
    showError(e);
  }
};

logoutBtn.onclick=async()=>{ try{ await signOut(auth); }catch(e){ showError(e); } };

/* ---------- UI ---------- */
const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");
const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");
const createBtn=document.getElementById("createBtn");
const joinBtn=document.getElementById("joinBtn");
const copyLinkBtn=document.getElementById("copyLinkBtn");
const roomIdInput=document.getElementById("roomId");
const mediaStatus=document.getElementById("mediaStatus");
const callStatus=document.getElementById("callStatus");
const setStatus=(el,msg)=>el.textContent=msg;

/* ✅ keep Copy Invite enabled whenever it makes sense */
function refreshCopyInviteState(){
  const hasRoomId = !!roomIdInput.value.trim();
  copyLinkBtn.disabled = !(isAuthed && hasRoomId);
}

/* ---------- STATE ---------- */
let localStream=null, pc=null;
let unsubRoomA=null, unsubCalleeA=null;
let unsubRoomB=null, unsubCallerB=null;
let lastAnsweredSessionB=null;
let startingPromise=null;
let autoJoinDone=false;

/* ---------- URL HASH ---------- */
if (location.hash.length > 1) {
  roomIdInput.value = location.hash.slice(1);
  setStatus(callStatus, "Room ID detected in URL.");
}
refreshCopyInviteState();

/* ---------- WEBRTC ---------- */
const rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

function closePeer(){
  if(pc){pc.close();pc=null}
  remoteVideo.srcObject=null;
}

function ensurePeer(){
  closePeer();
  pc=new RTCPeerConnection(rtcConfig);
  const rs=new MediaStream();
  remoteVideo.srcObject=rs;
  pc.ontrack=e=>e.streams[0].getTracks().forEach(t=>rs.addTrack(t));
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

/* ---------- HELPERS ---------- */
async function clearSub(col){
  const s=await getDocs(col);
  const b=writeBatch(db);
  s.forEach(d=>b.delete(d.ref));
  if(!s.empty) await b.commit();
}

function requireAuth(){
  if(!isAuthed) throw new Error("Not signed in. Please login first.");
}

/* ---------- MEDIA ---------- */
async function startMedia(){
  requireAuth();
  if(localStream) return;
  if(startingPromise) return startingPromise;

  startingPromise=(async()=>{
    setStatus(mediaStatus,"Requesting camera/mic…");
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject=localStream;

    startBtn.disabled=true;
    stopBtn.disabled=false;
    createBtn.disabled=false;
    joinBtn.disabled=false;

    setStatus(mediaStatus,"Camera/mic started.");
    await autoJoinIfNeeded();
  })();

  try{await startingPromise}finally{startingPromise=null}
}

function stopAll(){
  if(unsubRoomA){unsubRoomA();unsubRoomA=null}
  if(unsubCalleeA){unsubCalleeA();unsubCalleeA=null}
  if(unsubRoomB){unsubRoomB();unsubRoomB=null}
  if(unsubCallerB){unsubCallerB();unsubCallerB=null}
  closePeer();
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream=null;
  }
  localVideo.srcObject=null;

  startBtn.disabled=!isAuthed;
  stopBtn.disabled=true;
  createBtn.disabled=true;
  joinBtn.disabled=true;

  setStatus(mediaStatus,"Not started.");
  setStatus(callStatus,"No room yet.");
  autoJoinDone=false;
  lastAnsweredSessionB=null;

  refreshCopyInviteState();
}

/* ---------- AUTO JOIN ---------- */
async function autoJoinIfNeeded(){
  if(autoJoinDone) return;
  if(!roomIdInput.value) return;
  autoJoinDone=true;
  setStatus(callStatus,"Auto-joining room…");
  await joinRoom();
}

/* ---------- ROOM A ---------- */
async function createRoom(){
  requireAuth();
  await startMedia();

  if(unsubRoomA) unsubRoomA();
  if(unsubCalleeA) unsubCalleeA();

  const roomRef=roomIdInput.value
    ? doc(db,"rooms",roomIdInput.value)
    : doc(collection(db,"rooms"));

  roomIdInput.value=roomRef.id;
  location.hash=roomRef.id;

  refreshCopyInviteState();  // ✅ enable Copy Invite immediately

  const caller=collection(roomRef,"callerCandidates");
  const callee=collection(roomRef,"calleeCandidates");
  await clearSub(caller); await clearSub(callee);

  ensurePeer();
  pc.onicecandidate=e=>e.candidate&&addDoc(caller,e.candidate.toJSON());

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  await setDoc(roomRef,{
    session:Date.now(),
    offer:{type:offer.type,sdp:offer.sdp}
  });

  setStatus(callStatus,"Room active. Click 'Copy Invite' and send it to Person B.");

  unsubRoomA=onSnapshot(roomRef,snap=>{
    const d=snap.data();
    if(d?.answer && pc && pc.signalingState==="have-local-offer")
      pc.setRemoteDescription(d.answer);
  });

  unsubCalleeA=onSnapshot(callee,s=>{
    s.docChanges().forEach(c=>pc && pc.addIceCandidate(c.doc.data()));
  });
}

/* ---------- ROOM B ---------- */
async function joinRoom(){
  requireAuth();
  await startMedia();

  if(unsubRoomB) unsubRoomB();
  if(unsubCallerB) unsubCallerB();

  const roomId=roomIdInput.value.trim();
  if(!roomId) throw new Error("Room ID is empty.");

  const roomRef=doc(db,"rooms",roomId);
  const snap=await getDoc(roomRef);
  if(!snap.exists()) throw new Error("Room not found");

  await setDoc(roomRef,{joinRequest:Date.now()},{merge:true});
  setStatus(callStatus,"Connecting…");

  unsubRoomB=onSnapshot(roomRef,async s=>{
    const d=s.data();
    if(!d?.offer||lastAnsweredSessionB===d.session) return;
    lastAnsweredSessionB=d.session;

    ensurePeer();
    const caller=collection(roomRef,"callerCandidates");
    const callee=collection(roomRef,"calleeCandidates");
    await clearSub(callee);

    pc.onicecandidate=e=>e.candidate&&addDoc(callee,e.candidate.toJSON());
    await pc.setRemoteDescription(d.offer);
    const ans=await pc.createAnswer();
    await pc.setLocalDescription(ans);
    await updateDoc(roomRef,{answer:ans,session:d.session});

    setStatus(callStatus,"Connected.");

    unsubCallerB=onSnapshot(caller,s=>{
      s.docChanges().forEach(c=>pc && pc.addIceCandidate(c.doc.data()));
    });
  });
}

/* ---------- AUTH STATE ---------- */
onAuthStateChanged(auth,(user)=>{
  isAuthed=!!user;

  if(user){
    loginOverlay.style.display="none";
    appRoot.classList.remove("locked");
    logoutBtn.style.display="inline-block";
    loginStatus.textContent="Signed in.";

    startBtn.disabled=false;
    setStatus(mediaStatus,"Ready. Click Start (or tap page) to enable camera/mic.");

    refreshCopyInviteState();

    ["click","keydown","touchstart"].forEach(ev=>{
      window.addEventListener(ev,()=>startMedia().catch(()=>{}),{once:true});
    });

  }else{
    loginOverlay.style.display="flex";
    appRoot.classList.add("locked");
    logoutBtn.style.display="none";
    stopAll();
  }
});

/* ---------- UI ---------- */
startBtn.onclick=()=>startMedia().catch(showError);
stopBtn.onclick=()=>stopAll();
createBtn.onclick=()=>createRoom().catch(showError);
joinBtn.onclick=()=>joinRoom().catch(showError);

copyLinkBtn.onclick = () => {
  const roomId = roomIdInput.value.trim();
  if (!roomId) return;
  const invite = `${location.origin}${location.pathname}#${roomId}`;
  navigator.clipboard.writeText(invite);
  setStatus(callStatus, "Invite copied.");
};

roomIdInput.addEventListener("input",()=>{
  refreshCopyInviteState(); // ✅ keep it in sync
});
</script>
</body>
</html>
