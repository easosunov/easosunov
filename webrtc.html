001 <!doctype html>
002 <html lang="en">
003 <head>
004 <meta charset="utf-8"/>
005 <meta name="viewport" content="width=device-width,initial-scale=1"/>
006 <title>2-Person Video/Sound Communicator (WebRTC)</title>
007 
008 <style>
009 body{font-family:system-ui;margin:16px}
010 h1{font-size:20px;margin:0 0 10px}
011 .row{display:flex;gap:12px;flex-wrap:wrap}
012 .card{border:1px solid #ddd;border-radius:12px;padding:12px;flex:1 1 320px}
013 .videos{display:grid;grid-template-columns:1fr 1fr;gap:12px}
014 @media (max-width: 720px){ .videos{grid-template-columns:1fr} }
015 video{width:100%;background:#000;border-radius:12px;aspect-ratio:16/9}
016 button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
017 button:disabled{opacity:.6;cursor:not-allowed}
018 input{padding:10px 12px;border-radius:10px;border:1px solid #ccc;width:100%}
019 .status{font-size:13px;margin-top:8px}
020 .small{font-size:12px;color:#555;margin-top:6px}
021 
022 #errorBox{
023   display:none;margin:12px 0;padding:10px;
024   border:1px solid #f3b5b5;background:#fff5f5;
025   color:#7a1b1b;border-radius:12px;white-space:pre-wrap
026 }
027 
028 /* LOGIN OVERLAY */
029 #loginOverlay{
030   position:fixed; inset:0; z-index:9999;
031   background:rgba(0,0,0,.55);
032   display:flex; align-items:center; justify-content:center;
033 }
034 #loginCard{
035   width:min(520px,calc(100% - 24px));
036   background:#fff; border-radius:14px;
037   padding:16px;
038   box-shadow:0 10px 30px rgba(0,0,0,.35);
039 }
040 #loginRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
041 #logoutBtn{float:right}
042 #app.locked{filter:blur(2px);opacity:.35;pointer-events:none;user-select:none}
043 
044 /* DIAGNOSTICS */
045 #diagBox{
046   display:none;
047   margin-top:8px;
048   max-height:220px;
049   overflow:auto;
050   background:#111;
051   color:#0f0;
052   padding:8px;
053   border-radius:8px;
054   font-size:12px;
055   white-space:pre-wrap;
056 }
057 .diagActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
058 
059 /* INCOMING CALL MODAL */
060 #incomingOverlay{
061   position:fixed; inset:0; z-index:9998;
062   background:rgba(0,0,0,.55);
063   display:none; align-items:center; justify-content:center;
064 }
065 #incomingCard{
066   width:min(520px,calc(100% - 24px));
067   background:#fff; border-radius:14px;
068   padding:16px;
069   box-shadow:0 10px 30px rgba(0,0,0,.35);
070 }
071 .incomingActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
072 #answerBtn{background:#e8fff0;border-color:#bdeccc}
073 #declineBtn{background:#fff0f0;border-color:#f1bcbc}
074 </style>
075 </head>
076 
077 <body>
078 <h1>2-Person Video/Sound Communicator (WebRTC)</h1>
079 
080 <div id="errorBox"></div>
081 
082 <!-- INCOMING CALL -->
083 <div id="incomingOverlay">
084   <div id="incomingCard">
085     <h2 style="margin:0 0 8px;font-size:18px;">Incoming call</h2>
086     <div id="incomingText" class="status">Someone is calling…</div>
087     <div class="small">If you don’t hear ringing, tap once anywhere to enable sound.</div>
088     <div class="incomingActions">
089       <button id="answerBtn">Answer</button>
090       <button id="declineBtn">Decline</button>
091     </div>
092   </div>
093 </div>
094 
095 <!-- LOGIN -->
096 <div id="loginOverlay">
097   <div id="loginCard">
098     <button id="logoutBtn" style="display:none;">Logout</button>
099     <h2 style="margin:0 0 8px;font-size:18px;">Sign in required</h2>
100     <div class="small">Only approved users can access this communicator.</div>
101 
102     <label class="small">Email</label>
103     <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="username"/>
104 
105     <label class="small">Password</label>
106     <input id="passInput" type="password" placeholder="••••••••" autocomplete="current-password"/>
107 
108     <div id="loginRow">
109       <button id="loginBtn">Login</button>
110     </div>
111     <div id="loginStatus" class="status">Please sign in.</div>
112     <div class="small">Tip: If you mistype, you will see a message here (no pink error box).</div>
113   </div>
114 </div>
115 
116 <div id="app" class="locked">
117 
118   <div class="videos">
119     <div class="card">
120       <b>Person A (You)</b>
121       <video id="localVideo" autoplay muted playsinline></video>
122       <div class="small">Muted so you don’t hear yourself.</div>
123     </div>
124     <div class="card">
125       <b>Person B (Other)</b>
126       <video id="remoteVideo" autoplay playsinline></video>
127       <div class="small">If audio doesn’t play, click the video once.</div>
128     </div>
129   </div>
130 
131   <!-- PHONE CALLING -->
132   <div class="row" style="margin-top:12px">
133     <div class="card">
134       <b>Phone calling</b><br/><br/>
135 
136       <div class="small">Your phone number (used only for in-app lookup)</div>
137       <input id="myPhoneInput" placeholder="+15551234567"/>
138       <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
139         <button id="savePhoneBtn" disabled>Save My Number</button>
140         <button id="testSoundBtn" disabled>Test Ring Sound</button>
141         <button id="enablePushBtn" disabled>Enable Push Notifications</button>
142       </div>
143       <div class="status" id="phoneStatus">Not set.</div>
144       <div class="status" id="pushStatus">Push: not enabled.</div>
145 
146       <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
147 
148       <div class="small">Call another user by phone number</div>
149       <input id="calleePhoneInput" placeholder="+15557654321"/>
150       <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
151         <button id="callBtn" disabled>Call</button>
152         <button id="hangupBtn" disabled>Hang up</button>
153       </div>
154       <div class="status" id="phoneCallStatus">Idle.</div>
155       <div class="small">Tip: both users must be signed in and have saved their phone number.</div>
156     </div>
157   </div>
158 
159   <!-- ORIGINAL STEPS -->
160   <div class="row" style="margin-top:12px">
161     <div class="card">
162       <b>Step 1</b><br/><br/>
163       <button id="startBtn" disabled>Start</button>
164       <button id="stopBtn" disabled>Stop</button>
165       <div class="status" id="mediaStatus">Not started.</div>
166     </div>
167 
168     <div class="card">
169       <b>Step 2</b><br/><br/>
170       <button id="createBtn" disabled>Create Room</button>
171       <button id="joinBtn" disabled>Join Room</button>
172       <div class="small" style="margin-top:8px">Room ID</div>
173       <input id="roomId" placeholder="Room ID"/>
174       <div style="margin-top:8px">
175         <button id="copyLinkBtn" disabled>Copy Invite</button>
176       </div>
177       <div class="status" id="callStatus">No room yet.</div>
178       <div class="small">Invite format: <code>.../webrtc.html#ROOM_ID</code></div>
179     </div>
180   </div>
181 
182   <div class="card" style="margin-top:12px">
183     <button id="diagBtn">Diagnostics</button>
184     <div class="diagActions">
185       <button id="copyDiagBtn" disabled>Copy log</button>
186       <button id="clearDiagBtn" disabled>Clear log</button>
187     </div>
188     <pre id="diagBox"></pre>
189     <div class="small">Diagnostics are hidden by default. Click “Diagnostics” to show/hide.</div>
190   </div>
191 </div>
192 
193 <script type="module">
194 console.log("APP VERSION:", "2025-12-31-pushfix-1");
195 
196 // ✅ Put your real VAPID public key here (you already have it)
197 const PUBLIC_VAPID_KEY = "BCB4B8uFw0ZJuzKHLBCJO22NNpupe88jBwkriTwvQALDpWUeJ3umIkNJTLrb0L_eLeu2HyBNbogHc67YfNzM";
198 console.log("PUBLIC_VAPID_KEY CHECK:", PUBLIC_VAPID_KEY.slice(0, 10));
199 
200 /* ================== ELEMENTS ================== */
201 const errorBox = document.getElementById("errorBox");
202 
203 const loginOverlay = document.getElementById("loginOverlay");
204 const loginBtn = document.getElementById("loginBtn");
205 const logoutBtn = document.getElementById("logoutBtn");
206 const loginStatus = document.getElementById("loginStatus");
207 const emailInput = document.getElementById("emailInput");
208 const passInput = document.getElementById("passInput");
209 const appRoot = document.getElementById("app");
210 
211 const localVideo = document.getElementById("localVideo");
212 const remoteVideo = document.getElementById("remoteVideo");
213 const startBtn = document.getElementById("startBtn");
214 const stopBtn  = document.getElementById("stopBtn");
215 const createBtn= document.getElementById("createBtn");
216 const joinBtn  = document.getElementById("joinBtn");
217 const copyLinkBtn = document.getElementById("copyLinkBtn");
218 const roomIdInput = document.getElementById("roomId");
219 const mediaStatus = document.getElementById("mediaStatus");
220 const callStatus  = document.getElementById("callStatus");
221 
222 const diagBtn = document.getElementById("diagBtn");
223 const diagBox = document.getElementById("diagBox");
224 const copyDiagBtn = document.getElementById("copyDiagBtn");
225 const clearDiagBtn = document.getElementById("clearDiagBtn");
226 
227 /* Phone call UI */
228 const myPhoneInput = document.getElementById("myPhoneInput");
229 const savePhoneBtn = document.getElementById("savePhoneBtn");
230 const phoneStatus = document.getElementById("phoneStatus");
231 const pushStatus = document.getElementById("pushStatus");
232 const calleePhoneInput = document.getElementById("calleePhoneInput");
233 const callBtn = document.getElementById("callBtn");
234 const hangupBtn = document.getElementById("hangupBtn");
235 const phoneCallStatus = document.getElementById("phoneCallStatus");
236 const testSoundBtn = document.getElementById("testSoundBtn");
237 const enablePushBtn = document.getElementById("enablePushBtn");
238 
239 /* Incoming modal */
240 const incomingOverlay = document.getElementById("incomingOverlay");
241 const incomingText = document.getElementById("incomingText");
242 const answerBtn = document.getElementById("answerBtn");
243 const declineBtn = document.getElementById("declineBtn");
244 
245 const setStatus = (el,msg)=> el.textContent = msg;
246 
247 /* ================== DIAGNOSTICS ================== */
248 let diagVisible = false;
249 const diagLog = [];
250 function logDiag(msg){
251   const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
252   diagLog.push(line);
253   console.log(line);
254   if (diagVisible) {
255     diagBox.textContent = diagLog.join("\n");
256     diagBox.scrollTop = diagBox.scrollHeight;
257   }
258   copyDiagBtn.disabled = diagLog.length === 0;
259   clearDiagBtn.disabled = diagLog.length === 0;
260 }
261 diagBtn.onclick = () => {
262   diagVisible = !diagVisible;
263   diagBox.style.display = diagVisible ? "block" : "none";
264   diagBtn.textContent = diagVisible ? "Hide diagnostics" : "Diagnostics";
265   if (diagVisible) {
266     diagBox.textContent = diagLog.join("\n");
267     diagBox.scrollTop = diagBox.scrollHeight;
268   }
269 };
270 clearDiagBtn.onclick = () => {
271   diagLog.length = 0;
272   if (diagVisible) diagBox.textContent = "";
273   copyDiagBtn.disabled = true;
274   clearDiagBtn.disabled = true;
275   logDiag("Diagnostics cleared.");
276 };
277 copyDiagBtn.onclick = async () => {
278   const text = diagLog.join("\n");
279   if (!text) return;
280   try{
281     await navigator.clipboard.writeText(text);
282     logDiag("Copied diagnostics to clipboard.");
283   }catch{
284     window.prompt("Copy diagnostics:", text);
285   }
286 };
287 
288 /* ================== ERROR HANDLING ================== */
289 function showError(e){
290   const code = e?.code ? `\ncode: ${e.code}` : "";
291   const msg  = e?.message ? `\nmessage: ${e.message}` : "";
292   errorBox.style.display = "block";
293   errorBox.textContent = `${String(e?.stack || "")}${code}${msg}`.trim() || String(e);
294   logDiag("ERROR: " + String(e?.code || "") + " :: " + String(e?.message || e));
295 }
296 function hideErrorBox(){
297   errorBox.style.display = "none";
298   errorBox.textContent = "";
299 }
300 window.addEventListener("error", (e)=> showError(e.error || e.message || e));
301 window.addEventListener("unhandledrejection", (e)=> showError(e.reason || e));
302 emailInput.addEventListener("input", () => { hideErrorBox(); loginStatus.textContent=""; });
303 passInput.addEventListener("input", () => { hideErrorBox(); loginStatus.textContent=""; });
304 
305 /* ================== FIREBASE ================== */
306 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
307 import {
308   getFirestore, doc, collection, addDoc, setDoc, getDoc, updateDoc,
309   onSnapshot, getDocs, writeBatch, query, where, limit, orderBy, serverTimestamp
310 } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
311 import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-messaging.js";
312 import {
313   getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
314   setPersistence, inMemoryPersistence
315 } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
316 
317 const app = initializeApp({
318   apiKey:"AIzaSyAg6TXwgejbPAyuEPEBqW9eHaZyLV4Wq98",
319   authDomain:"easosunov-webrtc.firebaseapp.com",
320   projectId:"easosunov-webrtc",
321   storageBucket:"easosunov-webrtc.firebasestorage.app",
322   messagingSenderId:"100169991412",
323   appId:"1:100169991412:web:27ef6820f9a59add6b4aa1"
324 });
325 const db = getFirestore(app);
326 const auth = getAuth(app);
327 await setPersistence(auth, inMemoryPersistence);
328 
329 /* ================== AUTH GATE ================== */
330 let isAuthed = false;
331 let myUid = null;
332 
333 // ✅ MUST exist before handlePushOpen() runs (prevents Login from breaking)
334 let pendingIncomingCallWhileLoggedOut = null;
335 
336 async function enforceAllowlist(user){
337   const ref = doc(db, "allowlistUids", user.uid);
338   const snap = await getDoc(ref);
339   if(!snap.exists() || snap.data()?.enabled !== true){
340     try{ await signOut(auth); }catch{}
341     throw new Error("This account is not approved. Ask admin to allowlist your UID.");
342   }
343 }
344 
345 function requireAuthOrPrompt(){
346   if (isAuthed) return true;
347   loginOverlay.style.display = "flex";
348   appRoot.classList.add("locked");
349   loginStatus.textContent = "Please sign in first.";
350   return false;
351 }
352 
353 loginBtn.onclick = async () => {
354   hideErrorBox();
355   loginStatus.textContent = "Signing in…";
356   try {
357     await signInWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value);
358   } catch (e) {
359     loginStatus.textContent = `Login failed: ${e?.code || "unknown"}`;
360     try { logDiag("LOGIN ERROR PROPS: " + JSON.stringify(e, Object.getOwnPropertyNames(e))); } catch {}
361     showError(e);
362   }
363 };
364 
365 logoutBtn.onclick = async () => { try { await signOut(auth); } catch(e){ showError(e); } };
366 
367 /* ================== HANDLE OPEN FROM PUSH (TAB WAS CLOSED) ================== */
368 (function handlePushOpen(){
369   try{
370     const qs = new URLSearchParams(location.search);
371     const callId = qs.get("callId");
372     const roomId = qs.get("roomId");
373     const fromPhone = qs.get("fromPhone");
374     const toPhone = qs.get("toPhone");
375 
376     if(callId && roomId){
377       incomingText.textContent = `Call from ${fromPhone || "unknown"}…`;
378       incomingOverlay.style.display = "flex";
379       startRingtone();
380 
381       pendingIncomingCallWhileLoggedOut = {
382         id: callId,
383         data: { roomId, fromPhone, toPhone }
384       };
385 
386       roomIdInput.value = roomId;
387     }
388   }catch(e){
389     console.warn("Push open parse failed", e);
390   }
391 })();
392 
393 /* ================== HELPERS ================== */
394 function normalizePhone(p){ return String(p || "").trim().replace(/\s+/g,""); }
395 function isE164(p){ return /^\+\d{5,20}$/.test(p); }
396 
397 /* ================== PUSH (optional) ================== */
398 let messaging = null;
399 let swReg = null;
400 
401 async function enablePush(){
402   logDiag("enablePush(): ENTER");
403   logDiag("enablePush(): Notification.permission=" + (("Notification" in window) ? Notification.permission : "n/a"));
404 
405   if(!requireAuthOrPrompt()) return;
406 
407   if (!("Notification" in window)) { setStatus(pushStatus, "Push: not supported in this browser."); return; }
408   if (!("serviceWorker" in navigator)) { setStatus(pushStatus, "Push: service worker not supported."); return; }
409   if(!PUBLIC_VAPID_KEY || String(PUBLIC_VAPID_KEY).includes("PASTE_")) { setStatus(pushStatus, "Push: set PUBLIC_VAPID_KEY in HTML first."); return; }
410 
411   try{
412     // ✅ IMPORTANT: register SW relative to this HTML file (fixes GitHub Pages subpath 404)
413     const swUrl = new URL("firebase-messaging-sw.js", location.href);
414     logDiag("enablePush(): registering SW at " + swUrl.toString());
415 
416     swReg = await navigator.serviceWorker.register(swUrl);
417     logDiag("SW registered OK. scope=" + (swReg?.scope || ""));
418 
419     messaging = getMessaging(app);
420 
421     const perm = await Notification.requestPermission();
422     logDiag("enablePush(): Notification.requestPermission() => " + perm);
423     if (perm !== "granted"){ setStatus(pushStatus, "Push: permission not granted."); return; }
424 
425     const token = await getToken(messaging, { vapidKey: PUBLIC_VAPID_KEY, serviceWorkerRegistration: swReg });
426     if(!token){ setStatus(pushStatus, "Push: no token returned."); return; }
427 
428     const tokenId = token.slice(0, 32);
429     await setDoc(doc(db, "users", myUid, "fcmTokens", tokenId), {
430       token, createdAt: Date.now(), ua: navigator.userAgent, enabled: true
431     }, { merge:true });
432 
433     const phone = normalizePhone(myPhoneInput.value || localStorage.getItem("myPhone") || "");
434     if (isE164(phone)) {
435       await setDoc(doc(db, "phonePushTokens", phone, "tokens", tokenId), {
436         token, createdAt: Date.now(), ua: navigator.userAgent, enabled: true
437       }, { merge:true });
438       logDiag("FCM token stored for phone " + phone);
439     } else {
440       logDiag("FCM token NOT stored (phone missing/invalid)");
441     }
442 
443     setStatus(pushStatus, "Push: enabled.");
444     logDiag("FCM token stored.");
445 
446     onMessage(messaging, (payload)=>{
447       logDiag("FCM foreground message: " + JSON.stringify(payload));
448       const data = payload?.data || {};
449       if (data.roomId) roomIdInput.value = data.roomId;
450 
451       incomingText.textContent =
452         payload?.notification?.body ||
453         (data.fromPhone ? `Call from ${data.fromPhone}` : "Incoming call…");
454 
455       incomingOverlay.style.display = "flex";
456       startRingtone();
457     });
458 
459   }catch(e){
460     setStatus(pushStatus, "Push: failed (see diagnostics).");
461     logDiag("Push enable failed: " + (e?.message || e));
462   }
463 }
464 
465 // ✅ Single click handler (prevents “double enablePush” logs)
466 enablePushBtn.onclick = (ev)=>{
467   ev.preventDefault();
468   ev.stopPropagation();
469   logDiag("Enable Push button clicked");
470   enablePush().catch(showError);
471 };
472 
473 /* ================== RINGTONE ================== */
474 let audioCtx = null;
475 let ringOsc = null;
476 let ringGain = null;
477 let ringTimer = null;
478 
479 function ensureAudio(){
480   if(!audioCtx){
481     audioCtx = new (window.AudioContext || window.webkitAudioContext)();
482   }
483   return audioCtx;
484 }
485 async function unlockAudio(){
486   try{
487     const ctx = ensureAudio();
488     if(ctx.state !== "running") await ctx.resume();
489   }catch{}
490 }
491 window.addEventListener("click", ()=>{ unlockAudio(); }, { once:false, passive:true });
492 
493 function startRingtone(){
494   stopRingtone();
495   try{
496     const ctx = ensureAudio();
497     if(ctx.state !== "running") ctx.resume().catch(()=>{});
498     ringGain = ctx.createGain();
499     ringGain.gain.value = 0.08;
500     ringGain.connect(ctx.destination);
501 
502     ringOsc = ctx.createOscillator();
503     ringOsc.type = "sine";
504     ringOsc.frequency.value = 880;
505     ringOsc.connect(ringGain);
506     ringOsc.start();
507 
508     let on = true;
509     ringTimer = setInterval(()=>{
510       if(!ringGain) return;
511       ringGain.gain.value = on ? 0.08 : 0.0001;
512       on = !on;
513     }, 450);
514 
515     logDiag("Ringtone started.");
516   }catch(e){
517     logDiag("Ringtone failed: " + (e?.message || e));
518   }
519 }
520 function stopRingtone(){
521   if(ringTimer){ clearInterval(ringTimer); ringTimer=null; }
522   try{ if(ringOsc){ ringOsc.stop(); } }catch{}
523   try{ if(ringOsc){ ringOsc.disconnect(); } }catch{}
524   try{ if(ringGain){ ringGain.disconnect(); } }catch{}
525   ringOsc = null;
526   ringGain = null;
527 }
528 
529 /* ================== REST OF YOUR APP ==================
530    Keep your existing WebRTC + calls logic below this line.
531    (I’m not rewriting it here to avoid breaking what already works.)
532 ======================================================= */
533 
534 // TODO: paste your existing createRoom/joinRoom/calls logic here unchanged.
535 // (If you want, paste it and I’ll merge it into this file with correct line numbers.)
536 
537 /* ================== AUTH STATE ================== */
538 onAuthStateChanged(auth, async (user)=>{
539   isAuthed = !!user;
540   myUid = user?.uid || null;
541   logDiag(isAuthed ? "Auth: signed in" : "Auth: signed out");
542 
543   if (isAuthed){
544     try{ await enforceAllowlist(user); }
545     catch(e){ showError(e); return; }
546 
547     loginOverlay.style.display = "none";
548     appRoot.classList.remove("locked");
549     logoutBtn.style.display = "inline-block";
550     loginStatus.textContent = "Signed in.";
551 
552     // Enable UI bits
553     enablePushBtn.disabled = false;
554     testSoundBtn.disabled = false;
555     savePhoneBtn.disabled = !isE164(normalizePhone(myPhoneInput.value));
556   } else {
557     loginOverlay.style.display = "flex";
558     appRoot.classList.add("locked");
559     logoutBtn.style.display = "none";
560 
561     enablePushBtn.disabled = true;
562     testSoundBtn.disabled = true;
563     savePhoneBtn.disabled = true;
564     setStatus(pushStatus, "Push: not enabled.");
565   }
566 });
567 </script>
568 </body>
569 </html>
