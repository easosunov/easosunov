<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>2-Person Video/Sound Communicator (WebRTC)</title>

<style>
body{font-family:system-ui;margin:16px}
h1{font-size:20px;margin:0 0 10px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{border:1px solid #ddd;border-radius:12px;padding:12px;flex:1 1 320px}
.videos{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 720px){ .videos{grid-template-columns:1fr} }
video{width:100%;background:#000;border-radius:12px;aspect-ratio:16/9}
button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
input{padding:10px 12px;border-radius:10px;border:1px solid #ccc;width:100%}
.status{font-size:13px;margin-top:8px}
.small{font-size:12px;color:#555;margin-top:6px}

#errorBox{
  display:none;margin:12px 0;padding:10px;
  border:1px solid #f3b5b5;background:#fff5f5;
  color:#7a1b1b;border-radius:12px;white-space:pre-wrap
}

/* LOGIN OVERLAY */
#loginOverlay{
  position:fixed; inset:0; z-index:9999;
  background:rgba(0,0,0,.55);
  display:flex; align-items:center; justify-content:center;
}
#loginCard{
  width:min(520px,calc(100% - 24px));
  background:#fff; border-radius:14px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
#loginRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
#logoutBtn{float:right}
#app.locked{filter:blur(2px);opacity:.35;pointer-events:none;user-select:none}

/* DIAGNOSTICS */
#diagBox{
  display:none;
  margin-top:8px;
  max-height:220px;
  overflow:auto;
  background:#111;
  color:#0f0;
  padding:8px;
  border-radius:8px;
  font-size:12px;
  white-space:pre-wrap;
}
.diagActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}

/* INCOMING CALL MODAL */
#incomingOverlay{
  position:fixed; inset:0; z-index:9998;
  background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
}
#incomingCard{
  width:min(520px,calc(100% - 24px));
  background:#fff; border-radius:14px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.incomingActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
#answerBtn{background:#e8fff0;border-color:#bdeccc}
#declineBtn{background:#fff0f0;border-color:#f1bcbc}
</style>
</head>

<body>
<h1>2-Person Video/Sound Communicator (WebRTC)</h1>

<div id="errorBox"></div>

<!-- INCOMING CALL -->
<div id="incomingOverlay">
  <div id="incomingCard">
    <h2 style="margin:0 0 8px;font-size:18px;">Incoming call</h2>
    <div id="incomingText" class="status">Someone is calling…</div>
    <div class="small">If you don’t hear ringing, tap once anywhere to enable sound.</div>
    <div class="incomingActions">
      <button id="answerBtn">Answer</button>
      <button id="declineBtn">Decline</button>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginCard">
    <button id="logoutBtn" style="display:none;">Logout</button>
    <h2 style="margin:0 0 8px;font-size:18px;">Sign in required</h2>
    <div class="small">Only approved users can access this communicator.</div>

    <label class="small">Email</label>
    <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="username"/>

    <label class="small">Password</label>
    <input id="passInput" type="password" placeholder="••••••••" autocomplete="current-password"/>

    <div id="loginRow">
      <button id="loginBtn">Login</button>
    </div>
    <div id="loginStatus" class="status">Please sign in.</div>
  </div>
</div>

<div id="app" class="locked">

  <div class="videos">
    <div class="card">
      <b>Person A (You)</b>
      <video id="localVideo" autoplay muted playsinline></video>
      <div class="small">Muted so you don’t hear yourself.</div>
    </div>
    <div class="card">
      <b>Person B (Other)</b>
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="small">If audio doesn’t play, click the video once.</div>
    </div>
  </div>

  <!-- PHONE CALLING -->
  <div class="row" style="margin-top:12px">
    <div class="card">
      <b>Phone calling</b><br/><br/>

      <div class="small">Your phone number (used only for in-app lookup)</div>
      <input id="myPhoneInput" placeholder="+15551234567"/>
      <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="savePhoneBtn" disabled>Save My Number</button>
        <button id="testSoundBtn" disabled>Test Ring Sound</button>
        <button id="enablePushBtn" disabled>Enable Push Notifications</button>
      </div>
      <div class="status" id="phoneStatus">Not set.</div>
      <div class="status" id="pushStatus">Push: not enabled.</div>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

      <div class="small">Call another user by phone number</div>
      <input id="calleePhoneInput" placeholder="+15557654321"/>
      <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="callBtn" disabled>Call</button>
        <button id="hangupBtn" disabled>Hang up</button>
      </div>
      <div class="status" id="phoneCallStatus">Idle.</div>

      <div class="small" style="margin-top:8px">
        Push requires a separate file next to this HTML: <code>firebase-messaging-sw.js</code>
      </div>
    </div>
  </div>

  <!-- ORIGINAL STEPS -->
  <div class="row" style="margin-top:12px">
    <div class="card">
      <b>Step 1</b><br/><br/>
      <button id="startBtn" disabled>Start</button>
      <button id="stopBtn" disabled>Stop</button>
      <div class="status" id="mediaStatus">Not started.</div>
    </div>

    <div class="card">
      <b>Step 2</b><br/><br/>
      <button id="createBtn" disabled>Create Room</button>
      <button id="joinBtn" disabled>Join Room</button>
      <div class="small" style="margin-top:8px">Room ID</div>
      <input id="roomId" placeholder="Room ID"/>
      <div style="margin-top:8px">
        <button id="copyLinkBtn" disabled>Copy Invite</button>
      </div>
      <div class="status" id="callStatus">No room yet.</div>
      <div class="small">Invite format: <code>.../webrtc.html#ROOM_ID</code></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <button id="diagBtn">Diagnostics</button>
    <div class="diagActions">
      <button id="copyDiagBtn" disabled>Copy log</button>
      <button id="clearDiagBtn" disabled>Clear log</button>
    </div>
    <pre id="diagBox"></pre>
    <div class="small">Diagnostics are hidden by default. Click “Diagnostics” to show/hide.</div>
  </div>
</div>

<script type="module">
console.log("APP VERSION:", "2025-12-31-1");
const PUBLIC_VAPID_KEY = "BCB4B8uFw0ZJuzKHLBCJO22NNpupe88jBwkriTwvQALDpWUeJ3umIkNJTLrb0L_eLeu2HyBNbogHc67YfNzM";

/* ================== ELEMENTS ================== */
const errorBox = document.getElementById("errorBox");

const loginOverlay = document.getElementById("loginOverlay");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginStatus = document.getElementById("loginStatus");
const emailInput = document.getElementById("emailInput");
const passInput = document.getElementById("passInput");
const appRoot = document.getElementById("app");

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const createBtn= document.getElementById("createBtn");
const joinBtn  = document.getElementById("joinBtn");
const copyLinkBtn = document.getElementById("copyLinkBtn");
const roomIdInput = document.getElementById("roomId");
const mediaStatus = document.getElementById("mediaStatus");
const callStatus  = document.getElementById("callStatus");

const diagBtn = document.getElementById("diagBtn");
const diagBox = document.getElementById("diagBox");
const copyDiagBtn = document.getElementById("copyDiagBtn");
const clearDiagBtn = document.getElementById("clearDiagBtn");

/* Phone call UI */
const myPhoneInput = document.getElementById("myPhoneInput");
const savePhoneBtn = document.getElementById("savePhoneBtn");
const phoneStatus = document.getElementById("phoneStatus");
const pushStatus = document.getElementById("pushStatus");
const calleePhoneInput = document.getElementById("calleePhoneInput");
const callBtn = document.getElementById("callBtn");
const hangupBtn = document.getElementById("hangupBtn");
const phoneCallStatus = document.getElementById("phoneCallStatus");
const testSoundBtn = document.getElementById("testSoundBtn");
const enablePushBtn = document.getElementById("enablePushBtn");

/* Incoming modal */
const incomingOverlay = document.getElementById("incomingOverlay");
const incomingText = document.getElementById("incomingText");
const answerBtn = document.getElementById("answerBtn");
const declineBtn = document.getElementById("declineBtn");

const setStatus = (el,msg)=> el.textContent = msg;

/* ================== DIAGNOSTICS ================== */
let diagVisible = false;
const diagLog = [];
function logDiag(msg){
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  diagLog.push(line);
  console.log(line);
  if (diagVisible) {
    diagBox.textContent = diagLog.join("\n");
    diagBox.scrollTop = diagBox.scrollHeight;
  }
  copyDiagBtn.disabled = diagLog.length === 0;
  clearDiagBtn.disabled = diagLog.length === 0;
}
diagBtn.onclick = () => {
  diagVisible = !diagVisible;
  diagBox.style.display = diagVisible ? "block" : "none";
  diagBtn.textContent = diagVisible ? "Hide diagnostics" : "Diagnostics";
  if (diagVisible) {
    diagBox.textContent = diagLog.join("\n");
    diagBox.scrollTop = diagBox.scrollHeight;
  }
};
clearDiagBtn.onclick = () => {
  diagLog.length = 0;
  if (diagVisible) diagBox.textContent = "";
  copyDiagBtn.disabled = true;
  clea
