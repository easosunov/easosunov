<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2-Person Video/Sound Communicator (WebRTC)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; flex: 1 1 320px; }
    .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .videos { grid-template-columns: 1fr; } }
    video { width: 100%; background: #000; border-radius: 12px; aspect-ratio: 16/9; }
    label { font-size: 12px; color: #444; display: block; margin: 8px 0 6px; }
    input[type="text"] { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .small { font-size: 12px; color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .status { margin-top: 10px; font-size: 13px; }
    #errorBox {
      display:none; margin: 12px 0; padding: 10px 12px;
      border: 1px solid #f3b5b5; background: #fff5f5; color: #7a1b1b;
      border-radius: 12px; white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>2-Person Video/Sound Communicator (WebRTC)</h1>
  <div id="errorBox"></div>

  <div class="videos">
    <div class="card">
      <div><strong>Person A (You)</strong> — your webcam + mic</div>
      <video id="localVideo" playsinline autoplay muted></video>
      <div class="small">Muted so you don’t hear yourself (remote audio will play).</div>
    </div>

    <div class="card">
      <div><strong>Person B (Other)</strong> — remote webcam + mic</div>
      <video id="remoteVideo" playsinline autoplay></video>
      <div class="small">If audio doesn’t play, click the video once (browser autoplay rules).</div>
    </div>
  </div>

  <div class="row" style="margin-top: 12px;">
    <div class="card">
      <div><strong>Step 1:</strong> Start camera & mic</div>
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
      <div class="status" id="mediaStatus">Not started.</div>
    </div>

    <div class="card">
      <div><strong>Step 2:</strong> Create or join a room</div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="createBtn" disabled>Create Room (Person A)</button>
        <button id="joinBtn" disabled>Join Room (Person B)</button>
      </div>

      <label for="roomId">Room ID</label>
      <input id="roomId" type="text" placeholder="(Create a room or paste one here)" />

      <div style="margin-top:10px;">
        <button id="copyLinkBtn" disabled>Copy Invite Link</button>
      </div>

      <div class="status" id="callStatus">No room yet.</div>
      <div class="small" style="margin-top:8px;">
        Tip: room ID is also taken from URL hash, like <span class="mono">.../webrtc.html#ROOM_ID</span>
      </div>
    </div>
  </div>

  <script type="module">
    const errorBox = document.getElementById("errorBox");
    function showError(err) {
      errorBox.style.display = "block";
      errorBox.textContent = String(err?.stack || err);
    }
    window.addEventListener("error", (e) => showError(e.error || e.message || e));
    window.addEventListener("unhandledrejection", (e) => showError(e.reason || e));

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, collection, addDoc, setDoc, getDoc, updateDoc,
      onSnapshot, getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAg6TXwgejbPAyuEPEBqW9eHaZyLV4Wq98",
      authDomain: "easosunov-webrtc.firebaseapp.com",
      projectId: "easosunov-webrtc",
      storageBucket: "easosunov-webrtc.firebasestorage.app",
      messagingSenderId: "100169991412",
      appId: "1:100169991412:web:27ef6820f9a59add6b4aa1"
    };

    // ---- UI ----
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const createBtn = document.getElementById("createBtn");
    const joinBtn = document.getElementById("joinBtn");
    const copyLinkBtn = document.getEle
